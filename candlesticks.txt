1. Real-world / logic considerations
1.1 Shooting-star color restriction
if (range_ > 0 and body_ratio > 0 and direction == 'bull'):


Canonical shooting star doesn’t require a bullish body; a bearish body is often considered stronger. With this line you’ll never classify a classic bearish shooting star (close below open).

Not a bug, but an intentional restriction. If you want to match most textbooks:

if range_ > 0 and body_ratio > 0:
    ...
    # drop the direction == 'bull' guard, and maybe prefer bearish in explanation


or, if you want to be explicit:

if range_ > 0 and body_ratio > 0 and direction in ('bull', 'bear'):


and mention in the explanation that a bearish body is the stronger version.

1.2 Trend defaults: sometimes True, sometimes False

You’re using two different philosophies:

Singles: hammer / shooting star / hanging man all start with has_uptrend = True or has_downtrend = True (so they can trigger without context).

Pairs (tweezers) and trios (stars): trend defaults to False and must be proven by candles_before.

That’s okay as long as it’s intentional, but it does mean:

A hammer can appear in the middle of a chop zone and still be labeled “hammer-like (bullish bias)” if there’s no context.

A tweezer top/bottom or Morning/Evening Star will not trigger if you don’t have enough prior candles.

If the goal is consistency, you might change the singles to default False too:

has_downtrend = False
...
if candles_before and len(candles_before) >= 3:
    ...
# and then only trigger if has_downtrend


Right now it’s more generous with singles.

2. Small correctness / clarity nits

None of these will break things; they’re just cleanup / polish.

2.1 Unused constants and variables

In classify_candle_trio:

MIN_BODY_SIZE_RATIO = 0.3
SMALL_BODY_MAX_RATIO = 0.3
high1 = candle1.get('high', 0)
low1  = ...
high3 = ...
low3  = ...


MIN_BODY_SIZE_RATIO and SMALL_BODY_MAX_RATIO aren’t used (you hard-coded 0.7, 0.25, 0.30 instead), and high1/low1/high3/low3 aren’t referenced later.

You can either remove them or actually wire the constants into the conditions, e.g.:

candle1_strong = (dir1 == 'bear' and body_ratio1 >= MIN_BODY_SIZE_RATIO)  # if you want


Just to avoid confusion later.

2.2 Minor doc vs code mismatch

Three white soldiers comment: “Body ≥60% of range” but code uses c_body_ratio > 0.6.
If you care about exactness, change to >= 0.6 or tweak the comment.

Same for other “≥70%” vs >= 0.7 / > 0.7 – just keep them aligned with your final thresholds.

2.3 Tolerance clamp for tweezers
price_tolerance = max(avg_high * 0.0002, 0.01)


For something like a $3 stock, 0.01 is ~0.33%; for an index at 500, it’s tiny. That may be fine for your typical instruments, but just be aware that penny names will get a relatively fat tolerance band.

If you ever want to be more proportional, you could:

Use only the percentage,

Or clamp to a smaller absolute minimum, e.g. 0.001.

Totally up to how it looks in practice.