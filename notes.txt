Perfect — Option A (wall-clock window stepping) is the right choice for your “velocity-controlled practice field,” and it will eliminate the confusing “15 minutes expected, 50 minutes actual” behavior you just saw when there are gaps in the 1-minute series. 

replay_smoke

What changes with Option A

A “display step” means:

Advance the display window by exactly disp_tf_sec in real time (e.g., 5 minutes)

Inside that window, process all exec bars whose timestamps fall within [window_start, window_end)

So if there’s a 36-minute gap in the 1-minute feed (as your diagnostics showed), the clock still advances by 5 minutes per step, but you might consume 0 exec bars for that window (and you should log that explicitly). 

replay_smoke

Concrete implementation notes for Cursor
1) Add display-window cursor state

In ReplaySessionState keep:

cursor_disp_start_ts

cursor_disp_end_ts (or compute as start + disp_tf)

cursor_exec_ts (last processed exec ts)

cursor_exec_idx (optional, for debug)

2) Implement step as time windows (not bar counts)

Pseudo-logic:

Let disp_start = current_disp_end (or start)

Let disp_end = disp_start + disp_tf_sec

Consume exec bars where disp_start <= bar.ts < disp_end

For each consumed exec bar:

evaluate fills

update position/pnl

append events

Set cursor_disp_end_ts = disp_end

Set cursor_exec_ts = last_consumed_exec_ts (or leave unchanged if none)

3) Handle “no exec bars in window” cleanly

This will happen due to:

market closed

missing minutes

requested time outside available data

In that case:

Advance display clock anyway

Return a display candle as NA/empty or “no-trade candle” (your choice), but do not invent OHLC

Emit an event like WINDOW_EMPTY (helps debug + analytics)

4) Snap display windows to boundaries (recommended default)

Your session currently starts at 13:18, but 5-minute bars on charts are aligned to :00/:05/:10.... 

replay_smoke


So on session start:

snap t_start up to next display boundary (e.g., 13:20 for 5m)

keep original requested start stored separately for audit

5) Update the smoke test expectations

Right now replay_smoke.py assumes continuous 1-minute bars to predict cursor advance. 

replay_smoke


With Option A, that expectation becomes true again:

disp_steps=3, disp_tf_sec=300 ⇒ clock advances exactly 900 seconds, always.

So after the change, the smoke output should show:

cursor display time advances 15m

exec bars consumed may be 0..15 depending on gaps

6) One more improvement to the smoke test

Your comment says the placed limit isn’t guaranteed to fill. 

replay_smoke


For a more definitive v1 test, add an optional “guaranteed fill mode”:

buy limit at bars[0].high (or just a very high price) so low <= limit is always true and you can validate fill + logging deterministically.

How you’ll know you’re “green”

After Option A is implemented, rerun the smoke test and you should see:

Expected advance = actual advance (15m for 3×5m)

Exec bars consumed may be less than 15 if the window hits gaps

No more giant wall-clock jumps caused by missing minutes