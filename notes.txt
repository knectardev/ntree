Since your system already differentiates between **Bullish (Major)** and **Bearish (Minor)** states and utilizes a registry of semitone offsets for the bass, we can create a "Mid-Voice Harmony Registry" that mirrors this architecture.

The goal is to fill the "Inner Voice" gap using **Candle Body Height** to control harmonic density, while ensuring the notes remain within a specific middle-frequency range ( to ).

---

## 1. The "Mid-Voice" Harmony Logic

I propose a logic structure that uses **Dyads** (two-note intervals) or **Triads** (three-note chords) based on the candle's energy.

### Harmonic Selection based on Candle State

* **Bullish Candles:** Focus on the **Major 3rd** and **Major 7th** to provide that bright, "Jazz Major" feel seen in your UI settings.
* **Bearish Candles:** Focus on the **Minor 3rd** and **Perfect 5th** (or Minor 6th) to provide a darker, grounded texture.
* **Doji (Small Body):** Play only the **Root** or **5th** to minimize harmonic clutter during low-volatility periods.

### The "Body Height" Velocity Multiplier

The candle body height should map to the **MIDI Velocity** (volume) and **Density**:

* **Tiny Body:** 1 note (The "Shell" voicing).
* **Average Body:** 2 notes (The "Interval" voicing).
* **Large Body (Marubozu):** 3-4 notes (The "Full" voicing).

---

## 2. Proposed Registry Structure (`harmony_styles.js`)

Following the pattern in your `bass_styles.js`, here is how you can implement the inner voice accompaniment:

```javascript
/**
 * audio/harmony_styles.js â€” Inner Voice / Accompaniment Registry
 */
(function() {
    'use strict';
    const _am = window._audioModule;

    const HARMONY_STYLES = {
        jazz_shell_voicings: {
            label: 'Jazz Shell (3rds & 7ths)',
            range: ['C3', 'C5'],
            // Offsets from Chord Root
            bullish: [4, 11], // Major 3rd, Major 7th
            bearish: [3, 10]  // Minor 3rd, Minor 7th
        },
        power_chords_thick: {
            label: 'Rock Power Stacks',
            range: ['G2', 'G4'],
            bullish: [0, 7, 12], // Root, 5th, Octave
            bearish: [0, 7, 12]  // Consistent "thick" feel
        },
        ambient_sustained_pad: {
            label: 'Ambient Tension',
            range: ['C4', 'C5'],
            bullish: [4, 7, 9],  // Major 3rd, 5th, 6th (add6)
            bearish: [3, 7, 8]   // Minor 3rd, 5th, Minor 6th
        },
        orchestral_strings: {
            label: 'Orchestral Fill',
            range: ['C3', 'A4'],
            bullish: [0, 4, 7],  // Basic Major Triad
            bearish: [0, 3, 7]   // Basic Minor Triad
        }
    };

    _am.HARMONY_STYLES = HARMONY_STYLES;
})();

```

---

## 3. Algorithm: The "Inner Voice" Selector

When a new candle forms, the `pathfinder.js` logic can trigger the harmony:

1. **Check Body Size:** Calculate .
2. **Determine Chord:** Fetch current chord from your **Jazz (ii-V-I)** engine.
3. **Apply Transposition:** Use the `HARMONY_STYLES` offsets relative to the **Root Key**.
4. **Stay in Bounds:** If the price-driven note exceeds the defined `range` (e.g., ), use a modulo operator to "wrap" the note back down an octave, ensuring it never clashes with the Soprano/Upper Wick instrument.

To implement the inner voice harmony, we can leverage the candle body's "displacement" (the distance between Open and Close) to control the **voicing density** and **velocity**.

Since your system already handles root keys and progressions like **Jazz (ii-V-I)**, the following logic will ensure the inner voice stays musically relevant while reacting to price volatility.

---

## 1. Defining the Mid-Voice Registry

Using the structure of your `bass_styles.js`, we can define "Voicing Templates" that respond to the Bullish or Bearish state of the candle.

```javascript
/**
 * audio/harmony_styles.js 
 * Logic: Body Height -> Chord Density | Body State -> Chord Quality
 */
const HARMONY_MODES = {
    jazz_voicing: {
        label: 'Jazz Mid-range (3rds & 7ths)',
        // Semitone offsets from chord root
        bullish: [4, 7, 11], // Major Triad + Maj7
        bearish: [3, 7, 10], // Minor Triad + m7
        instrument_suggestions: ['Rhodes', 'Warm Pad']
    },
    classical_trio: {
        label: 'Classical Trio',
        bullish: [0, 4, 7],  // Major Triad
        bearish: [0, 3, 7],  // Minor Triad
        instrument_suggestions: ['Strings', 'Organ']
    }
};

```

---

## 2. The Harmonic Calculation Algorithm

The "Inner Voice" should reside in the mid-frequency range ( to ) to avoid clashing with your high-pitched **Harmonica** (Upper Wick) or low **Acoustic Bass** (Lower Wick).

### Step A: Determine Density from Body Height

The algorithm calculates the pixel height of the candle body.

* **Small Body (Doji/Consolidation):** Play only the **3rd** of the chord (The "Color" note).
* **Medium Body:** Play the **3rd and 7th** (The "Shell" voicing).
* **Large Body (Expansion):** Play the full **Triad (1, 3, 5, 7)**.

### Step B: Coordinate with the Bass Line

Your `bass_styles.js` uses semitone offsets to create movement. To keep the mid-voice stable, we use **Inversion Logic**:

1. Identify the note currently being played by the **Acoustic Bass**.
2. Select the mid-voice notes that are furthest from the bass note to prevent "muddiness."
3. **Bullish State:** Map to the **Major/Natural Minor** scale setting.
4. **Bearish State:** Map to the parallel minor or diminished tones if the price drop is significant.

---

## 3. Implementation Logic (Pseudo-code)

You can drop this logic into your `pathfinder.js` or equivalent playback engine:

```javascript
function triggerInnerVoice(candle, currentChord) {
    const bodyHeight = Math.abs(candle.open - candle.close);
    const isBullish = candle.close > candle.open;
    
    // 1. Get offsets based on Bullish (Major) or Bearish (Minor) state
    const style = HARMONY_MODES.jazz_voicing;
    const offsets = isBullish ? style.bullish : style.bearish;

    // 2. Determine how many notes to play based on "Pattern Density"
    // (Referencing your UI 'Pattern Density' slider)
    const densityLimit = bodyHeight > averageHeight ? offsets.length : 2;
    const activeNotes = offsets.slice(0, densityLimit);

    // 3. Map to MIDI Notes (keeping it between C3 and C4)
    activeNotes.forEach(offset => {
        const midiNote = currentChord.root + offset + 48; // +48 for mid-octave
        playInstrument('Piano/Organ', midiNote, velocity = bodyHeight * 0.8);
    });
}

```
