<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ symbol }} ({{ scenario }}) - Synthetic Detail</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 16px;
            background: #0b1220;
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        h1 { margin: 0; font-size: 1.8em; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 999px; background: #1f2937; color: #93c5fd; font-size: 0.85em; }
        .meta { color: #cbd5e1; font-size: 0.95em; }
        .card {
            background: #111827;
            border: 1px solid #1f2937;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.35);
        }
        #chartWrapper { height: 640px; }
        #status { margin-top: 10px; font-size: 0.95em; }
        .back-link {
            color: #93c5fd;
            text-decoration: none;
            font-weight: 600;
        }
        .back-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>{{ symbol }} ({{ scenario }}) <span class="badge">synthetic</span></h1>
                <div class="meta">Timeframe: {{ timeframe }}</div>
            </div>
            <a class="back-link" href="/">← Back to dashboard</a>
        </div>

        <div class="card">
            <div id="chartWrapper">
                <canvas id="syntheticDetailChart"></canvas>
            </div>
            <div id="status"></div>
        </div>
    </div>

    <script>
        const symbol = "{{ symbol }}";
        const scenario = "{{ scenario }}";
        const timeframe = "{{ timeframe }}";

        let chartInstance = null;

        function setStatus(text, tone = 'info') {
            const el = document.getElementById('status');
            if (!el) return;
            el.textContent = text || '';
            const colors = {
                info: '#cbd5e1',
                error: '#fca5a5',
                success: '#a7f3d0'
            };
            el.style.color = colors[tone] || colors.info;
        }

        function isoToEpochMs(iso) {
            const d = new Date(iso);
            return Number.isNaN(d.getTime()) ? null : d.getTime();
        }

        async function loadBars() {
            setStatus('Loading bars…', 'info');
            const params = new URLSearchParams({ symbol, scenario, timeframe, limit: 3000 });
            try {
                const res = await fetch(`/api/synthetic_bars?${params.toString()}`);
                if (!res.ok) {
                    throw new Error(await res.text());
                }
                const bars = await res.json();
                renderChart(bars);
                setStatus(`Loaded ${bars.length} bars`, 'success');
            } catch (err) {
                console.error(err);
                setStatus('Failed to load bars', 'error');
            }
        }

        function renderChart(bars) {
            const ctx = document.getElementById('syntheticDetailChart').getContext('2d');
            if (chartInstance) {
                chartInstance.destroy();
                chartInstance = null;
            }

            const candles = bars
                .map(b => {
                    const x = isoToEpochMs(b.ts_start);
                    if (x === null) return null;
                    return { x, o: b.open, h: b.high, l: b.low, c: b.close, v: b.volume || 0 };
                })
                .filter(Boolean);

            if (candles.length === 0) {
                setStatus('No data returned for this dataset', 'error');
                return;
            }

            const volumes = candles.map(c => ({ x: c.x, y: c.v }));

            chartInstance = new Chart(ctx, {
                type: 'candlestick',
                data: {
                    datasets: [
                        {
                            label: `${symbol} (${scenario})`,
                            data: candles,
                            color: { up: '#22c55e', down: '#ef4444', unchanged: '#94a3b8' },
                            borderColor: '#0f172a'
                        },
                        {
                            type: 'bar',
                            label: 'Volume',
                            data: volumes,
                            yAxisID: 'yVolume',
                            backgroundColor: 'rgba(147, 197, 253, 0.35)',
                            borderWidth: 0
                        }
                    ]
                },
                options: {
                    parsing: false,
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { tooltipFormat: 'yyyy-MM-dd HH:mm:ss' },
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#cbd5e1' }
                        },
                        y: {
                            position: 'right',
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: {
                                color: '#cbd5e1',
                                callback: v => '$' + v
                            }
                        },
                        yVolume: {
                            display: true,
                            position: 'left',
                            grid: { display: false },
                            ticks: { display: false },
                            suggestedMax: Math.max(...volumes.map(v => v.y || 0), 1)
                        }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', loadBars);
    </script>
</body>
</html>

