<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtest Config</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 24px;
            background: #0f172a;
            color: #e2e8f0;
        }
        h1 { margin-bottom: 8px; }
        .card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 16px;
            max-width: 720px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.25);
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 4px;
        }
        input, select, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 12px;
            border-radius: 6px;
            border: 1px solid #334155;
            background: #0b1220;
            color: #e2e8f0;
        }
        button {
            cursor: pointer;
            background: #6366f1;
            border: none;
            font-weight: 700;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }
        .results {
            margin-top: 16px;
            padding: 12px;
            background: #0b1220;
            border: 1px solid #334155;
            border-radius: 6px;
            font-size: 14px;
        }
        .error {
            color: #f87171;
            margin-top: 8px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <h1>Backtest Configuration</h1>
    <p>Define strategy-neutral backtest parameters to reuse elsewhere.</p>

    <div class="card">
        <form id="backtestForm">
            <label for="backtest_name">Configuration Name</label>
            <input id="backtest_name" name="backtest_name" type="text" placeholder="e.g., Default 2:1" required>

            <div class="row">
                <div>
                    <label for="risk_percent">Risk % (per trade)</label>
                    <input id="risk_percent" name="risk_percent" type="number" step="0.01" min="0" value="0.5">
                </div>
                <div>
                    <label for="reward_multiple">Reward multiple (profit-to-loss)</label>
                    <input id="reward_multiple" name="reward_multiple" type="number" step="0.1" min="0" value="2.0">
                </div>
                <div>
                    <label for="fee_bp">Fees (basis points)</label>
                    <input id="fee_bp" name="fee_bp" type="number" step="0.01" value="0">
                </div>
            </div>

            <button type="button" id="saveBtn">Save Configuration</button>

            <label for="savedSelect">Saved Configurations</label>
            <div class="row">
                <select id="savedSelect">
                    <option value="">-- choose saved configuration --</option>
                </select>
                <button type="button" id="refreshSavedBtn">Refresh</button>
                <button type="button" id="deleteSavedBtn">Delete Selected</button>
            </div>

            <div id="errorBox" class="error" style="display:none;"></div>
        </form>

        <div id="results" class="results" style="display:none;"></div>
    </div>

    <script>
        const resultsBox = document.getElementById('results');
        const errorBox = document.getElementById('errorBox');
        const saveBtn = document.getElementById('saveBtn');
        const savedSelect = document.getElementById('savedSelect');
        const refreshSavedBtn = document.getElementById('refreshSavedBtn');
        const deleteSavedBtn = document.getElementById('deleteSavedBtn');
        let savedBacktests = [];

        function collectPayload() {
            return {
                fee_bp: parseFloat(document.getElementById('fee_bp').value || '0'),
                risk_percent: parseFloat(document.getElementById('risk_percent').value || '0.5'),
                reward_multiple: parseFloat(document.getElementById('reward_multiple').value || '2.0')
            };
        }

        function renderResults(data) {
            const m = (data && data.metrics) || {};
            const lines = [
                `Trades: ${m.n_trades ?? '—'}`,
                `Win rate: ${m.win_rate != null ? (m.win_rate * 100).toFixed(1) + '%' : '—'}`,
                `Avg ret: ${m.avg_ret != null ? (m.avg_ret * 100).toFixed(2) + '%' : '—'}`,
                `Median: ${m.median_ret != null ? (m.median_ret * 100).toFixed(2) + '%' : '—'}`
            ].join('<br>');
            const nameLine = data.name ? `<strong>Name:</strong> ${data.name}<br>` : '';
            resultsBox.innerHTML = `
                ${nameLine}
                <strong>Risk %:</strong> ${data.risk_percent}<br>
                <strong>Reward multiple:</strong> ${data.reward_multiple}<br>
                <strong>Fees (bp):</strong> ${data.fee_bp}<br>
                <strong>Updated:</strong> ${data.updated_at || data.created_at || ''}<br>
            `;
            resultsBox.style.display = 'block';
        }

        function setLoading(isLoading, targetBtn, label) {
            targetBtn.disabled = isLoading;
            targetBtn.textContent = isLoading ? `${label}...` : label;
        }

        async function fetchSaved() {
            try {
                const resp = await fetch('/api/backtest-configs');
                const data = await resp.json();
                savedBacktests = Array.isArray(data) ? data : [];
                savedSelect.innerHTML = '<option value=\"\">-- choose saved configuration --</option>';
                savedBacktests.forEach(cfg => {
                    const opt = document.createElement('option');
                    opt.value = cfg.id;
                    opt.textContent = `${cfg.name} (R:${cfg.risk_percent}% / RR:${cfg.reward_multiple} / Fee:${cfg.fee_bp}bp)`;
                    savedSelect.appendChild(opt);
                });
            } catch (err) {
                console.error('Failed to load saved configurations', err);
            }
        }

        function loadSavedToForm(id) {
            const cfg = savedBacktests.find(x => String(x.id) === String(id));
            if (!cfg) return;
            document.getElementById('risk_percent').value = cfg.risk_percent;
            document.getElementById('reward_multiple').value = cfg.reward_multiple;
            document.getElementById('fee_bp').value = cfg.fee_bp;
            document.getElementById('backtest_name').value = cfg.name;
            renderResults(cfg);
        }

        savedSelect.addEventListener('change', (e) => {
            const id = e.target.value;
            if (id) {
                loadSavedToForm(id);
            }
        });

        saveBtn.addEventListener('click', async () => {
            errorBox.style.display = 'none';
            resultsBox.style.display = 'none';
            const name = document.getElementById('backtest_name').value.trim();
            if (!name) {
                errorBox.textContent = 'Name is required to save a configuration.';
                errorBox.style.display = 'block';
                return;
            }
            const payload = collectPayload();
            setLoading(true, saveBtn, 'Saving');
            try {
                const resp = await fetch('/api/backtest-configs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, ...payload })
                });
                const data = await resp.json();
                if (!resp.ok || data.error) {
                    throw new Error(data.error || 'Save failed');
                }
                renderResults(data);
                await fetchSaved();
                savedSelect.value = data.id;
            } catch (err) {
                errorBox.textContent = err.message || 'Unexpected error';
                errorBox.style.display = 'block';
            } finally {
                setLoading(false, saveBtn, 'Save Configuration');
            }
        });

        refreshSavedBtn.addEventListener('click', () => {
            fetchSaved();
        });

        deleteSavedBtn.addEventListener('click', async () => {
            errorBox.style.display = 'none';
            resultsBox.style.display = 'none';
            const id = savedSelect.value;
            if (!id) {
                errorBox.textContent = 'Choose a saved configuration to delete.';
                errorBox.style.display = 'block';
                return;
            }
            setLoading(true, deleteSavedBtn, 'Deleting');
            try {
                const resp = await fetch(`/api/backtest-configs/${id}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await resp.json();
                if (!resp.ok || data.error) {
                    throw new Error(data.error || 'Delete failed');
                }
                await fetchSaved();
                savedSelect.value = '';
                resultsBox.style.display = 'none';
            } catch (err) {
                errorBox.textContent = err.message || 'Unexpected error';
                errorBox.style.display = 'block';
            } finally {
                setLoading(false, deleteSavedBtn, 'Delete Selected');
            }
        });

        // Initial load
        fetchSaved();
    </script>
</body>
</html>

