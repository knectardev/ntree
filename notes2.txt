notes2.txt


Here are the specific directions to provide Cursor to answer those 6 questions and get the "Pathfinder" running:

### 1. Phrase Boundaries vs. Bar Boundaries

**The Direction:** **Allow phrases to carry across bar boundaries.**
Since your market data is fractal, a "trend" doesn't stop just because a new 1-minute candle started. If a scale run is mid-flight, let it finish.

* **The Rule:** Each bar change should update the **Target MIDI** (the new wick), but the **Sequencer** should continue its current "Run" or "Arpeggio" until that specific 4-note cell is complete. This prevents the "jarring" reset and makes the music feel like a continuous performance.

### 2. Should both voices use pathfinding?

**The Direction:** **Yes, but with different "Movement Rules."**

* **Soprano (High Wick):** High "Agility." Uses scale runs, trills, and enclosures. It "hugs" the wick tightly.
* **Bass (Low Wick):** High "Stability." Instead of runs, the bass should use **"Walking Bass"** logic—targeting the Low Wick but primarily moving in leaps (Root, 4th, 5th) or chromatic approaches.
* **Instruction for Cursor:** "Implement pathfinding for both, but use `executeRunStep` for Soprano and create a `executeWalkingStep` for Bass."

### 3. Handling Dead Code (Wiring vs. Rewrite)

**The Direction:** **Wire them in.**
The scaffolded functions (`executeRunStep`, `applyGenrePhrasing`, etc.) are high-quality building blocks. Rewriting from scratch would likely lose the genre-specific nuances already defined.

* **Instruction for Cursor:** "Refactor `processSubStep` to become the 'Conductor.' It should call `detectMelodicPattern`, decide if a `Run` or `Arpeggio` is needed, and then call the existing scaffolded functions to execute the notes."

### 4. Consolidating Playback Paths

**The Direction:** **Unify them into `processSubStep`.**
Having two different ways to generate a note is why you’re seeing "broken" behavior.

* **Instruction for Cursor:** "Delete `generateScore`. Route the Replay Hook (`onBarAdvance`) to simply update the `audioState` targets, and let the main `processSubStep` loop handle all note generation. This ensures the sound is identical whether you are in 'Live' mode or 'Replay' mode."

### 5. UI Slider Mapping

**The Direction:** **Add one new "Vertical Zoom" slider; repurpose "Sensitivity."**

* **Sensitivity Slider:** Rename/Repurpose this to **"Complexity/Stochasticism."** (0 = pure arpeggios; 1 = chaotic jumps and chromatic ornaments).
* **Vertical Zoom (New):** Add this to control how much the "Price-to-MIDI" mapping expands.
* **Instruction for Cursor:** "Add a 'Melodic Range' (Vertical Zoom) slider. Keep the UI clean by using 'Sensitivity' to drive the probability of the stochastic interruptions defined in the genre configs."

### 6. Genre Complexity feeding the Pathfinder

**The Direction:** **Absolutely yes.**
This is the "secret sauce."

* **Instruction for Cursor:** "Use the `ornamentChance` and `bebopEnclosureChance` from the Genre configs as the multipliers for the `audioState.sensitivity` value. If I'm in Jazz mode with high sensitivity, I should hear enclosures constantly; in Classical, I should hear trills."

---

### Final "Marching Orders" for Cursor:

"Cursor, thank you for the review. Please proceed with the following:

1. **Unify the Engine:** Route all playback through `processSubStep`.
2. **Activate the Pathfinder:** Wire the existing 'dead code' (`executeRunStep`, `getArpeggioNote`, `applyGenrePhrasing`) into the `processSubStep` loop.
3. **Dynamic Mapping:** Update `priceToMidi` to use the **visible viewport** (zoom level) rather than the full data range, so notes 'hug' the wicks visually.
4. **Sequential State:** Ensure the `stepCounter` drives 4-note 'cells' that can cross bar boundaries for a fluid sound.
5. **Fix `quantizeToChord`:** Implement the missing function using the existing `CHORD_MAPS`."

**This should break the stalemate. Once Cursor wires these up, the "stagnant chords" will disappear and be replaced by the "dancing" scale runs you are looking for.**
