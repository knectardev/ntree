After reviewing your `requirements.md` and comparing it to the current codebase logic, your approach is remarkably consistent. The app's architecture is well-suited for a mid-voice "harmonizer," but there are three specific areas where the requirements might create a conflict with the "inner voice" implementation.

### 1. The "Velocity vs. Density" Conflict

* **The Requirement:** You specify that **Candle Body Height** should determine the "energy" and "complexity" of the melody.
* **The Flag:** In the current **Drum Kit** settings, "Glow Intensity" and levels are handled via a slider. If the mid-voice uses body height to determine *how many* notes are played (density) AND the *volume* (velocity), a very tall candle could create a "sonic wall" that masks the Soprano (Upper Wick).
* **Recommendation:** Use a **non-linear mapping** for the mid-voice. As body height increases, increase the velocity (volume) first, and only add a third or fourth chord tone once a specific "volatility threshold" is crossed.

### 2. Sustain/Flow Overlap

* **The Requirement:** The "Flow / Sustain" is currently set at  in your Audio Visual Sync Tuning.
* **The Flag:** A high sustain works beautifully for "Strings" or "Vocal Backing," but if the **Chord Progression** (Jazz ii-V-I) changes while the previous mid-voice notes are still sustaining, you will get "harmonic mud" (dissonance between the old chord and the new one).
* **Recommendation:** Ensure your algorithm includes a **"Kill Signal"** or a rapid fade-out for mid-voice notes specifically upon a `chord_change` event, regardless of the global sustain setting.

### 3. Musical "Collision" with Bass Styles

* **The Requirement:** You are using complex bass styles like **Latin / Afro-Cuban Tumbao**.
* **The Flag:** In the `bass_styles.js` file, styles like `latin_afrocuban` use semitone offsets like `[0, 7, 10, 12]`. This means the bass is already jumping into the "Tenor" range (the 7th and 10th intervals).
* **Recommendation:** To avoid "frequency masking," the mid-voice should be "Bass-Aware."
* If the `Bass Line Style` is **Minimal/Pedal Drone**, the mid-voice can be complex.
* If the `Bass Line Style` is **Afrobeat/Polyrhythmic**, the mid-voice should be strictly rhythmic and limited to 1-2 notes to avoid clashing with the bass's melodic movement.



---

### Summary of Compatibility

| Feature | Compatibility | Risk Level |
| --- | --- | --- |
| **Root Key/Scale Sync** | **High** | Low - Already handled by `Music and Scale Settings`. |
| **Jazz ii-V-I Integration** | **High** | Low - Easily mapped to the 3rd and 7th offsets. |
| **Body Height Mapping** | **Moderate** | Medium - Needs a "Density Cap" to prevent audio clipping. |


To mitigate the **Velocity vs. Density** and **Frequency Collision** risks, keep these three implementation tips in mind as you review the code:

### 1. The "Velocity Ceiling"

Ensure that the cumulative gain of the Mid-Voice doesn't hit  when all three voices (Soprano, Mid, Bass) trigger simultaneously.

* **The Fix:** Implement a simple `Math.min()` cap on velocity. Even for a Marubozu (giant candle), the mid-voice velocity should likely max out at  of the Soprano's current volume to maintain the "Lead" hierarchy.

### 2. Frequency "Slotting"

Since your `bass_styles.js` includes styles like **Latin / Afro-Cuban Tumbao** that use high offsets (e.g., `+10, +12`), there is a risk of the bass note literally being higher than the mid-voice root.

* **The Fix:** Use a "transposition check." If `MidVoiceNote <= BassNote`, transpose the Mid-Voice up one octave ( semitones) instantly. This preserves the "Inner Voice" role regardless of how active the bass line gets.

### 3. The Chord-Change "Dampener"

Because your **Jazz (ii-V-I)** progression is the backbone, the mid-voice needs to be the most "stable" element.

* **The Fix:** If Cursor is building the "Restart on chord change" logic (which I see in your UI for Upper/Lower wicks), make sure the mid-voice uses a **Crossfade** rather than a hard restart. This will stop the  sustain from creating dissonant "ghost chords" during a transition from the `ii` to the `V`.

---

If the first draft feels too cluttered, we can always look at a **"Velocity Scaling"** function that lowers the volume of the mid-notes as you add more of them (Density-compensated Gain).

How is the generated code looking so farâ€”is it successfully pulling the `bullish` vs `bearish` states from your price engine?